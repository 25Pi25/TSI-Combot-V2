<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSI Combot Panel</title>
  <!-- api font -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Libre+Franklin:ital,wght@0,100..900;1,100..900&display=swap');
  </style>
  <style>
    * {
      font-family: 'Barlow';
    }
  </style>
</head>

<body>
  <br>
  <button class="d-block btn btn-warning m-auto" onclick="capture()">
    <h1>Capture</h1>
  </button>
  <br><br>
  <div class="d-flex">
    <div id="content" class="container w-auto d-inline-block"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
    crossorigin="anonymous"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
  <script>
    const socket = io();
    function capture() {
      html2canvas(document.getElementById("content"), { scale: 0.8 }).then(canvas => canvas.toBlob(blob => {
        const item = new ClipboardItem({ "image/png": blob });
        navigator.clipboard.write([item]);
      }));
    }
    // i've got no type checking here unfortunately
    socket.on('contentUpdate', (game, tactics) => {
      const playerGrid = game.players.sort((a, b) => b.initiative - a.initiative).map(player => {
        const tacticList = player.tactics.map(tactic => {
          const tacticInfo = tactics.find(t => t.name == tactic.name);
          const noUser = ["Fainted", "Dead", "Dying"].includes(tactic.name);
          const valenceTag = tacticInfo.effectType == "positive" ? "btn-success" : "btn-danger";
          return `<button class="btn ${valenceTag} mx-1">
            ${tactic.name} ${tactic.input ? `(${(tacticInfo.inputPrefix ?? "") + tactic.input})` : ""} ${tactic.turns > 1 ? `[${tactic.turns} Turns]` : ""} ${player.name != tactic.user && !noUser ? `{${tactic.user}}` : ""}
          </button>`
        });
        const playerColor = game.currentPlayer == player.name ? "#b7e1cd" :
          player.hasGone ? "#d9d9d9" :
            player.tactics.some(tactic => ["Fainted", "Dead"].includes(tactic.name)) ? "#999999" :
              "#ffffff";
        return `<div class="row border" style="min-height: 40px; background-color: ${playerColor};">
          <div class="col-auto d-flex justify-content-center align-items-center">
            <h5 class=" text-center align-middle mb-0">${player.name} (${player.initiative})</h5>
          </div>
            ${!tacticList.length ? "" : `
            <div class="col-auto p-1">
              ${tacticList.join("")}
            </div>
            `}
        </div>
        `;
      })
      document.getElementById('content').innerHTML = playerGrid.join("");
    });
  </script>
</body>

</html>